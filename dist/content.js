console.log("[CONTENT] Eden AI Sustainability Counter content script loaded");try{typeof chrome<"u"&&chrome.runtime&&chrome.runtime.id&&chrome.runtime.sendMessage({action:"openSidebar"})}catch(n){console.warn("[CONTENT] Cannot open sidebar:",n)}const l=['textarea[placeholder*="Reply to Claude"]','textarea[placeholder*="Talk to Claude"]','textarea[data-testid="chat-input"]','div[contenteditable="true"][role="textbox"]',"textarea.ProseMirror",'div.ProseMirror[contenteditable="true"]','textarea[aria-label*="message"]','div[contenteditable="true"]',"textarea",'input[type="text"]'];let d="",c="",i=!1;const N="https://hackmit2025-pf5p.onrender.com";async function g(n,t="claude-3-5-haiku-20241022",e=200){const o=await fetch(`${N}/count`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:n,model:t,expected_output_tokens:e})});if(!o.ok)throw new Error(`API request failed: ${o.status} ${o.statusText}`);return o.json()}function u(n,t="claude-3-5-haiku-20241022",e=200){return new Promise((o,r)=>{if(!chrome||!chrome.runtime||!chrome.runtime.id){console.warn("[CONTENT] Extension context missing; using direct fetch fallback"),g(n,t,e).then(o).catch(r);return}try{chrome.runtime.sendMessage({action:"countTokens",text:n,model:t,expectedOutputTokens:e},s=>{const a=chrome.runtime.lastError;if(a){if(String(a.message||"").includes("Extension context invalidated")){console.warn("[CONTENT] Context invalidated; using direct fetch fallback"),g(n,t,e).then(o).catch(r);return}return r(new Error(a.message))}return s&&s.success?o(s.data):r(new Error((s==null?void 0:s.error)||"Failed to count tokens"))})}catch(s){if(String(s.message||s).includes("Extension context invalidated")){console.warn("[CONTENT] Caught invalidated context; using direct fetch fallback"),g(n,t,e).then(o).catch(r);return}r(s)}})}chrome.storage.local.get(["edenMonitoringEnabled"],n=>{i=n.edenMonitoringEnabled!==!1,i&&f()});chrome.storage.onChanged.addListener((n,t)=>{t==="local"&&n.edenMonitoringEnabled&&(i=n.edenMonitoringEnabled.newValue,i?f():b())});function f(){console.log("[CONTENT] Starting input monitoring..."),l.forEach(t=>{document.querySelectorAll(t).forEach(o=>{h(o)})}),new MutationObserver(t=>{t.forEach(e=>{e.addedNodes.forEach(o=>{o.nodeType===Node.ELEMENT_NODE&&l.forEach(r=>{(o.querySelectorAll?o.querySelectorAll(r):[]).forEach(a=>h(a))})})})}).observe(document.body,{childList:!0,subtree:!0}),document.addEventListener("click",T,!0),document.addEventListener("keydown",k,!0)}function b(){console.log("[CONTENT] Stopping input monitoring..."),l.forEach(n=>{document.querySelectorAll(n).forEach(e=>{e.removeEventListener("input",m),e.removeEventListener("keydown",y,!0),e.removeEventListener("blur",E)})}),document.removeEventListener("click",T,!0),document.removeEventListener("keydown",k,!0)}function h(n){n.dataset.edenListenerAdded||(n.addEventListener("input",m),n.addEventListener("keydown",y,!0),n.addEventListener("blur",E),n.dataset.edenListenerAdded="true")}function m(n){if(!i)return;const t=n.target.value||n.target.textContent||"";t.length>10&&t!==d&&(d=t,console.log("[CONTENT] Input detected:",t.substring(0,50)+"..."))}function E(n){if(!i)return;const t=n.target.value||n.target.textContent||"";t.length>10&&t!==c&&(console.log("[CONTENT] Processing input on blur:",t.substring(0,50)+"..."),u(t,"claude-3-5-haiku-20241022",200).then(e=>{console.log("[CONTENT] Token count result:",e),chrome.storage.local.get(["edenUsageHistory"],o=>{const r=o.edenUsageHistory||[],s={...e,tokens:e.tokens_total_estimate??e.tokens??0,energy_kwh:e.kwh??e.energy_kwh??0,timestamp:new Date().toISOString(),text:t.substring(0,100)+(t.length>100?"...":"")};r.unshift(s),r.length>100&&r.splice(100),chrome.storage.local.set({edenUsageHistory:r})}),c=t}).catch(e=>{console.error("[CONTENT] Error counting tokens:",(e==null?void 0:e.message)||e)}))}function y(n){if(!i||n.key!=="Enter"||n.shiftKey)return;const t=n.target.value||n.target.textContent||"";t.length<=10||t!==c&&(console.log("[CONTENT] Enter pressed, sending:",t.substring(0,50)+"..."),u(t,"claude-3-5-haiku-20241022",200).then(e=>{console.log("[CONTENT] Token count result:",e),chrome.storage.local.get(["edenUsageHistory"],o=>{const r=o.edenUsageHistory||[],s={...e,tokens:e.tokens_total_estimate??e.tokens??0,energy_kwh:e.kwh??e.energy_kwh??0,timestamp:new Date().toISOString(),text:t.substring(0,100)+(t.length>100?"...":"")};r.unshift(s),r.length>100&&r.splice(100),chrome.storage.local.set({edenUsageHistory:r})}),c=t}).catch(e=>{console.error("[CONTENT] Error counting tokens:",(e==null?void 0:e.message)||e)}))}function k(n){if(!i||n.key!=="Enter"||n.shiftKey)return;const t=document.activeElement,e=t&&(t.value||t.textContent)||"";e.length<=10||e!==c&&(console.log("[CONTENT] Document keydown Enter, sending:",e.substring(0,50)+"..."),u(e,"claude-3-5-haiku-20241022",200).then(o=>{console.log("[CONTENT] Token count result:",o),chrome.storage.local.get(["edenUsageHistory"],r=>{const s=r.edenUsageHistory||[],a={...o,tokens:o.tokens_total_estimate??o.tokens??0,energy_kwh:o.kwh??o.energy_kwh??0,timestamp:new Date().toISOString(),text:e.substring(0,100)+(e.length>100?"...":"")};s.unshift(a),s.length>100&&s.splice(100),chrome.storage.local.set({edenUsageHistory:s})}),c=e}).catch(o=>{console.error("[CONTENT] Error counting tokens:",(o==null?void 0:o.message)||o)}))}function w(n){return n instanceof Element?['button[type="submit"]','button[aria-label*="Send" i]','[data-testid*="send" i]','[aria-label*="Send message" i]'].some(e=>n.closest(e)):!1}function C(n){const t=document.activeElement;if((r=>!r||!(r instanceof Element)?!1:l.some(s=>r.matches(s)))(t))return t.value||t.textContent||"";const o=n instanceof Element&&n.closest("body")||document;for(const r of l){const s=o.querySelector(r);if(s)return s.value||s.textContent||""}return""}function T(n){if(!i||!w(n.target))return;const t=C(n.target)||"";t.length<=10||t!==c&&(console.log("[CONTENT] Send click detected, sending:",t.substring(0,50)+"..."),u(t,"claude-3-5-haiku-20241022",200).then(e=>{console.log("[CONTENT] Token count result:",e),chrome.storage.local.get(["edenUsageHistory"],o=>{const r=o.edenUsageHistory||[],s={...e,tokens:e.tokens_total_estimate??e.tokens??0,energy_kwh:e.kwh??e.energy_kwh??0,timestamp:new Date().toISOString(),text:t.substring(0,100)+(t.length>100?"...":"")};r.unshift(s),r.length>100&&r.splice(100),chrome.storage.local.set({edenUsageHistory:r})}),c=t}).catch(e=>{console.error("[CONTENT] Error counting tokens:",(e==null?void 0:e.message)||e)}))}
