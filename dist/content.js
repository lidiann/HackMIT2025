console.log("Eden AI Sustainability Counter content script loaded");chrome.runtime.sendMessage({action:"openSidebar"});const i=['textarea[placeholder*="Reply to Claude"]','textarea[placeholder*="Talk to Claude"]','textarea[data-testid="chat-input"]','div[contenteditable="true"][role="textbox"]',"textarea.ProseMirror",'div.ProseMirror[contenteditable="true"]','textarea[aria-label*="message"]','div[contenteditable="true"]',"textarea",'input[type="text"]'];let s="",a=!1;chrome.storage.local.get(["edenMonitoringEnabled"],e=>{a=e.edenMonitoringEnabled!==!1,a&&d()});chrome.storage.onChanged.addListener((e,t)=>{t==="local"&&e.edenMonitoringEnabled&&(a=e.edenMonitoringEnabled.newValue,a?d():h())});function d(){console.log("Starting input monitoring..."),i.forEach(t=>{document.querySelectorAll(t).forEach(o=>{c(o)})}),new MutationObserver(t=>{t.forEach(n=>{n.addedNodes.forEach(o=>{o.nodeType===Node.ELEMENT_NODE&&i.forEach(r=>{(o.querySelectorAll?o.querySelectorAll(r):[]).forEach(f=>c(f))})})})}).observe(document.body,{childList:!0,subtree:!0})}function h(){console.log("Stopping input monitoring..."),i.forEach(e=>{document.querySelectorAll(e).forEach(n=>{n.removeEventListener("input",u),n.removeEventListener("blur",g)})})}function c(e){e.dataset.edenListenerAdded||(e.addEventListener("input",u),e.addEventListener("blur",g),e.dataset.edenListenerAdded="true")}function u(e){if(!a)return;const t=e.target.value||e.target.textContent||"";t.length>10&&t!==s&&(s=t,console.log("Input detected:",t.substring(0,50)+"..."))}function g(e){if(!a)return;const t=e.target.value||e.target.textContent||"";t.length>10&&(console.log("Processing input on blur:",t.substring(0,50)+"..."),chrome.runtime.sendMessage({action:"countTokens",text:t,model:"claude-3-5-haiku-20241022",expectedOutputTokens:200},n=>{n&&n.success?(console.log("Token count result:",n.data),chrome.storage.local.get(["edenUsageHistory"],o=>{const r=o.edenUsageHistory||[],l={...n.data,timestamp:new Date().toISOString(),text:t.substring(0,100)+(t.length>100?"...":"")};r.unshift(l),r.length>100&&r.splice(100),chrome.storage.local.set({edenUsageHistory:r})})):console.error("Error counting tokens:",n==null?void 0:n.error)}))}
