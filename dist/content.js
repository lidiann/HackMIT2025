console.log("[CONTENT] Eden AI Sustainability Counter content script loaded");try{typeof chrome<"u"&&chrome.runtime&&chrome.runtime.id&&chrome.runtime.sendMessage({action:"openSidebar"})}catch(o){console.warn("[CONTENT] Cannot open sidebar:",o)}const a=['textarea[placeholder*="Reply to Claude"]','textarea[placeholder*="Talk to Claude"]','textarea[data-testid="chat-input"]','div[contenteditable="true"][role="textbox"]',"textarea.ProseMirror",'div.ProseMirror[contenteditable="true"]','textarea[aria-label*="message"]','div[contenteditable="true"]',"textarea",'input[type="text"]'];let f="",c="",i=!1;const E="https://hackmit2025-pf5p.onrender.com";async function g(o,e="claude-3-5-haiku-20241022",t=200){const n=await fetch(`${E}/count`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:o,model:e,expected_output_tokens:t})});if(!n.ok)throw new Error(`API request failed: ${n.status} ${n.statusText}`);return n.json()}async function d(o){const e=await fetch(`${E}/score`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:o})});if(!e.ok)throw new Error(`Score API failed: ${e.status} ${e.statusText}`);return e.json()}function h(o,e){try{chrome.storage.local.get(["edenPromptScores"],t=>{const n=t.edenPromptScores||[],s={score:(e==null?void 0:e.score)??null,suggestions:(e==null?void 0:e.suggestions)??[],signals:(e==null?void 0:e.signals)??{},timestamp:new Date().toISOString(),text:o.substring(0,100)+(o.length>100?"...":"")};n.unshift(s),n.length>200&&n.splice(200),chrome.storage.local.set({edenPromptScores:n})})}catch(t){console.warn("[CONTENT] Failed to persist score:",t)}}function u(o,e="claude-3-5-haiku-20241022",t=200){return new Promise((n,s)=>{if(!chrome||!chrome.runtime||!chrome.runtime.id){console.warn("[CONTENT] Extension context missing; using direct fetch fallback"),g(o,e,t).then(n).catch(s);return}try{chrome.runtime.sendMessage({action:"countTokens",text:o,model:e,expectedOutputTokens:t},r=>{const l=chrome.runtime.lastError;if(l){if(String(l.message||"").includes("Extension context invalidated")){console.warn("[CONTENT] Context invalidated; using direct fetch fallback"),g(o,e,t).then(n).catch(s);return}return s(new Error(l.message))}return r&&r.success?n(r.data):s(new Error((r==null?void 0:r.error)||"Failed to count tokens"))})}catch(r){if(String(r.message||r).includes("Extension context invalidated")){console.warn("[CONTENT] Caught invalidated context; using direct fetch fallback"),g(o,e,t).then(n).catch(s);return}s(r)}})}chrome.storage.local.get(["edenMonitoringEnabled"],o=>{i=o.edenMonitoringEnabled!==!1,i&&y()});chrome.storage.onChanged.addListener((o,e)=>{e==="local"&&o.edenMonitoringEnabled&&(i=o.edenMonitoringEnabled.newValue,i?y():b())});function y(){console.log("[CONTENT] Starting input monitoring..."),a.forEach(e=>{document.querySelectorAll(e).forEach(n=>{m(n)})}),new MutationObserver(e=>{e.forEach(t=>{t.addedNodes.forEach(n=>{n.nodeType===Node.ELEMENT_NODE&&a.forEach(s=>{(n.querySelectorAll?n.querySelectorAll(s):[]).forEach(l=>m(l))})})})}).observe(document.body,{childList:!0,subtree:!0}),document.addEventListener("click",C,!0),document.addEventListener("keydown",w,!0)}function b(){console.log("[CONTENT] Stopping input monitoring..."),a.forEach(o=>{document.querySelectorAll(o).forEach(t=>{t.removeEventListener("input",T),t.removeEventListener("keydown",N,!0),t.removeEventListener("blur",k)})}),document.removeEventListener("click",C,!0),document.removeEventListener("keydown",w,!0)}function m(o){o.dataset.edenListenerAdded||(o.addEventListener("input",T),o.addEventListener("keydown",N,!0),o.addEventListener("blur",k),o.dataset.edenListenerAdded="true")}function T(o){if(!i)return;const e=o.target.value||o.target.textContent||"";e.length>10&&e!==f&&(f=e,console.log("[CONTENT] Input detected:",e.substring(0,50)+"..."))}function k(o){if(!i)return;const e=o.target.value||o.target.textContent||"";e.length>10&&e!==c&&(console.log("[CONTENT] Processing input on blur:",e.substring(0,50)+"..."),u(e,"claude-3-5-haiku-20241022",200).then(t=>{console.log("[CONTENT] Token count result:",t),chrome.storage.local.get(["edenUsageHistory"],n=>{const s=n.edenUsageHistory||[],r={...t,tokens:t.tokens_total_estimate??t.tokens??0,energy_kwh:t.kwh??t.energy_kwh??0,timestamp:new Date().toISOString(),text:e.substring(0,100)+(e.length>100?"...":"")};s.unshift(r),s.length>100&&s.splice(100),chrome.storage.local.set({edenUsageHistory:s})}),d(e).then(n=>h(e,n)).catch(n=>console.warn("[CONTENT] Score error:",(n==null?void 0:n.message)||n)),c=e}).catch(t=>{console.error("[CONTENT] Error counting tokens:",(t==null?void 0:t.message)||t)}))}function N(o){if(!i||o.key!=="Enter"||o.shiftKey)return;const e=o.target.value||o.target.textContent||"";e.length<=10||e!==c&&(console.log("[CONTENT] Enter pressed, sending:",e.substring(0,50)+"..."),u(e,"claude-3-5-haiku-20241022",200).then(t=>{console.log("[CONTENT] Token count result:",t),chrome.storage.local.get(["edenUsageHistory"],n=>{const s=n.edenUsageHistory||[],r={...t,tokens:t.tokens_total_estimate??t.tokens??0,energy_kwh:t.kwh??t.energy_kwh??0,timestamp:new Date().toISOString(),text:e.substring(0,100)+(e.length>100?"...":"")};s.unshift(r),s.length>100&&s.splice(100),chrome.storage.local.set({edenUsageHistory:s})}),d(e).then(n=>h(e,n)).catch(n=>console.warn("[CONTENT] Score error:",(n==null?void 0:n.message)||n)),c=e}).catch(t=>{console.error("[CONTENT] Error counting tokens:",(t==null?void 0:t.message)||t)}))}function w(o){if(!i||o.key!=="Enter"||o.shiftKey)return;const e=document.activeElement,t=e&&(e.value||e.textContent)||"";t.length<=10||t!==c&&(console.log("[CONTENT] Document keydown Enter, sending:",t.substring(0,50)+"..."),u(t,"claude-3-5-haiku-20241022",200).then(n=>{console.log("[CONTENT] Token count result:",n),chrome.storage.local.get(["edenUsageHistory"],s=>{const r=s.edenUsageHistory||[],l={...n,tokens:n.tokens_total_estimate??n.tokens??0,energy_kwh:n.kwh??n.energy_kwh??0,timestamp:new Date().toISOString(),text:t.substring(0,100)+(t.length>100?"...":"")};r.unshift(l),r.length>100&&r.splice(100),chrome.storage.local.set({edenUsageHistory:r})}),d(t).then(s=>h(t,s)).catch(s=>console.warn("[CONTENT] Score error:",(s==null?void 0:s.message)||s)),c=t}).catch(n=>{console.error("[CONTENT] Error counting tokens:",(n==null?void 0:n.message)||n)}))}function S(o){return o instanceof Element?['button[type="submit"]','button[aria-label*="Send" i]','[data-testid*="send" i]','[aria-label*="Send message" i]'].some(t=>o.closest(t)):!1}function p(o){const e=document.activeElement;if((s=>!s||!(s instanceof Element)?!1:a.some(r=>s.matches(r)))(e))return e.value||e.textContent||"";const n=o instanceof Element&&o.closest("body")||document;for(const s of a){const r=n.querySelector(s);if(r)return r.value||r.textContent||""}return""}function C(o){if(!i||!S(o.target))return;const e=p(o.target)||"";e.length<=10||e!==c&&(console.log("[CONTENT] Send click detected, sending:",e.substring(0,50)+"..."),u(e,"claude-3-5-haiku-20241022",200).then(t=>{console.log("[CONTENT] Token count result:",t),chrome.storage.local.get(["edenUsageHistory"],n=>{const s=n.edenUsageHistory||[],r={...t,tokens:t.tokens_total_estimate??t.tokens??0,energy_kwh:t.kwh??t.energy_kwh??0,timestamp:new Date().toISOString(),text:e.substring(0,100)+(e.length>100?"...":"")};s.unshift(r),s.length>100&&s.splice(100),chrome.storage.local.set({edenUsageHistory:s})}),c=e}).catch(t=>{console.error("[CONTENT] Error counting tokens:",(t==null?void 0:t.message)||t)}))}
